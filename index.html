
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario Prenotazioni</title>

  <!-- FullCalendar (GLOBAL) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- Supabase (GLOBAL UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, Arial;
      max-width: 1100px;
      margin: 18px auto;
      padding: 0 12px;
      background: #0b1220;
      color: #e5e7eb;
    }
    .card {
      border: 1px solid #243041;
      border-radius: 12px;
      padding: 14px;
      margin: 12px 0;
      background: #0f172a;
    }
    label { display:block; margin-top: 10px; }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #243041;
      border-radius: 10px;
      background: #0b1220;
      color: #e5e7eb;
    }
    button {
      padding: 10px 14px;
      margin-top: 12px;
      cursor: pointer;
      border: 1px solid #243041;
      border-radius: 10px;
      background: #111827;
      color: #e5e7eb;
    }
    button[disabled] { cursor: not-allowed; opacity: 0.6; }
    .row { display:flex; gap: 12px; align-items: end; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 220px; }
    .muted { opacity: .75; font-size: 13px; }

    #calendar { margin-top: 14px; min-height: 650px; }

    .legend { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .chip { display:inline-flex; align-items:center; gap:8px; border:1px solid #243041; border-radius:999px; padding:6px 10px; font-size:13px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }

    .fc { --fc-border-color: #243041; --fc-page-bg-color: #0f172a; font-size: 13px; }
    .fc .fc-toolbar-title { font-size: 18px; font-weight: 650; color: #e5e7eb; }
    .fc .fc-button {
      background: #111827 !important;
      border: 1px solid #243041 !important;
      color: #e5e7eb !important;
      border-radius: 10px !important;
      padding: 7px 10px !important;
    }
    .fc .fc-button:disabled { opacity: 0.5; }
    .fc .fc-daygrid-day-number { font-size: 12px; opacity: .85; padding: 6px; color: #cbd5e1; }
    .fc .fc-daygrid-day { background: #0f172a; }
    .fc .fc-daygrid-day.fc-day-sat,
    .fc .fc-daygrid-day.fc-day-sun { background: #0b1220; }
    .fc .fc-daygrid-day.fc-day-today { outline: 2px solid #e5e7eb; outline-offset: -2px; }
    .fc .fc-daygrid-event { border-radius: 8px; padding: 2px 6px; border: 0 !important; box-shadow: none; }
    .fc .fc-daygrid-event .fc-event-title {
      font-weight: 650;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .fc .fc-event-time { display: none; }
    .fc .cm-sub { font-size: 11px; opacity: .9; font-weight: 500; }
  </style>
</head>

<body>
  <h2>Calendario Prenotazioni</h2>

  <!-- LOGIN -->
  <div id="authCard" class="card">
    <h3>Login</h3>
    <div class="row">
      <div>
        <label>Email
          <input id="email" type="email" autocomplete="username" />
        </label>
      </div>
      <div>
        <label>Password
          <input id="password" type="password" autocomplete="current-password" />
        </label>
      </div>
      <div style="flex:0.8; min-width:260px;">
        <button id="btnLogin" type="button">Accedi</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appCard" class="card" style="display:none;">
    <div class="row">
      <div>
        <label>Struttura
          <select id="strutturaSelect"></select>
        </label>
      </div>
      <div style="flex:0.8; min-width:320px; display:flex; gap:10px; justify-content:flex-end;">
        <button id="btnReload" type="button">Ricarica calendario</button>
        <button id="btnLogout" type="button">Esci</button>
      </div>
    </div>

        <div class="legend">
      <span class="chip"><span class="dot" style="background:#BBF7D0"></span>Diretta</span>
      <span class="chip"><span class="dot" style="background:#FBCFE8"></span>Airbnb</span>
    </div>

    <div id="calendar"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://ybzoitxmlkjmfeoodqlq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inliem9pdHhtbGtqbWZlb29kcWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTI2MTIsImV4cCI6MjA4NDM4ODYxMn0.3kV-SnYCjvNay2PjZpz-MA6PZFDS-ZeAgufFbk1ZR6M";
    const STORAGE_KEY = "sb-auth-prenotazioni-v1";

    const el = (id) => document.getElementById(id);

    // NESSUNO STATO A VIDEO
    const log = (_msg) => {};

    // Sanity check (solo console)
    if (!window.FullCalendar) console.error("FullCalendar non caricato (CDN?).");
    if (!window.supabase) console.error("Supabase non caricato (CDN?).");

    const setLoading = (isLoading) => {
      const btn = el("btnReload");
      if (btn) btn.disabled = isLoading;
      const sel = el("strutturaSelect");
      if (sel) sel.disabled = isLoading;
    };

    // Supabase client (GLOBAL)
    const supabaseClient = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: STORAGE_KEY,
        storage: window.localStorage
      }
    });

    let calendar = null;
    let lastRangeKey = "";
    let reloadTimer = null;

    const pad2 = (n) => String(n).padStart(2, "0");

    // Normalizza date: se arriva una stringa "YYYY-MM-DD" la usa; se è datetime, la converte a data locale
    function toLocalYMD(v) {
      if (!v) return "";
      const s = String(v);
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const d = new Date(s);
      if (Number.isNaN(d.getTime())) return s.slice(0, 10);
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }

    const debounce = (fn, ms) => {
      return (...args) => {
        if (reloadTimer) clearTimeout(reloadTimer);
        reloadTimer = setTimeout(() => fn(...args), ms);
      };
    };

    function colorForDiretta(_stato) {
      return "#BBF7D0";
    }

function mapPrenotazioniToEvents(rows) {
      return (rows ?? []).map(r => ({
        id: "dir_" + r.id,
        title: (r.nome_ospite && r.nome_ospite.trim()) ? r.nome_ospite.trim() : "Diretta",
        start: toLocalYMD(r.checkin),
        end: toLocalYMD(r.checkout), // end esclusivo (checkout = giorno uscita)
        allDay: true,
        backgroundColor: colorForDiretta(r.stato),
        borderColor: "transparent",
        textColor: "#111827",
        extendedProps: { origine: "diretta", stato: r.stato ?? "" }
      })).filter(e => e.start && e.end);
    }

    function mapAirbnbToEvents(rows) {
      return (rows ?? []).map(r => ({
        id: "ab_" + r.id,
        title: r.titolo ?? "Airbnb",
        start: toLocalYMD(r.inizio),
        end: toLocalYMD(r.fine), // end esclusivo (fine = checkout)
        allDay: true,
        backgroundColor: "#FBCFE8",
        borderColor: "transparent",
        textColor: "#111827",
        extendedProps: { origine: r.origine ?? "airbnb_ical", stato: "" }
      })).filter(e => e.start && e.end);
    }

    function ensureCalendar() {
      if (calendar) return;

      const calEl = el("calendar");
      if (!calEl) return;
      if (!window.FullCalendar) return;

      calendar = new FullCalendar.Calendar(calEl, {
        initialView: "dayGridMonth",
        height: "auto",
        firstDay: 1,
        locale: "it",
        nowIndicator: true,
        navLinks: true,
        fixedWeekCount: false,
        showNonCurrentDates: false,
        eventDisplay: "block",
        dayMaxEvents: 6,

        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay"
        },

        eventContent: function(arg) {
          const titolo = arg.event.title || "";
          const origine = arg.event.extendedProps?.origine || "";
          const stato = arg.event.extendedProps?.stato || "";
          const sub = origine === "airbnb_ical" ? "Airbnb" : (origine === "diretta" ? "Diretta" : origine);
          const sub2 = stato ? ` • ${stato}` : "";

          const wrap = document.createElement("div");
          const line1 = document.createElement("div");
          line1.textContent = titolo;

          const line2 = document.createElement("div");
          line2.className = "cm-sub";
          line2.textContent = sub + sub2;

          wrap.appendChild(line1);
          wrap.appendChild(line2);
          return { domNodes: [wrap] };
        },

        eventDidMount: function(info) {
          const t = info.event.title;
          const o = info.event.extendedProps?.origine;
          const s = info.event.extendedProps?.stato;
          info.el.title = [t, o, s].filter(Boolean).join(" | ");
        },

        datesSet: debounce(async function(arg) {
          await reloadCalendarEvents(arg.start, arg.end);
        }, 180)
      });

      calendar.render();

      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          try { calendar.updateSize(); } catch (_) {}
        });
      });
    }

    async function loadStrutture() {
      const { data, error } = await supabaseClient.from("strutture").select("id,nome").order("nome");
      if (error) { console.error("Errore strutture:", error); return []; }

      const sel = el("strutturaSelect");
      sel.innerHTML = "";

      const rows = data ?? [];
      for (const s of rows) {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.nome;
        sel.appendChild(opt);
      }
      return rows;
    }

    async function reloadCalendarEvents(viewStartDate, viewEndDate) {
      const struttura_id = el("strutturaSelect")?.value;
      if (!struttura_id) return;
      if (!calendar) return;

      const start = toLocalYMD(viewStartDate.toISOString());
      const end = toLocalYMD(viewEndDate.toISOString());

      const rangeKey = `${struttura_id}|${start}|${end}`;
      if (rangeKey === lastRangeKey) return;
      lastRangeKey = rangeKey;

      setLoading(true);

      try {
        // Overlap corretto per intervalli [start,end): inizio < end AND fine > start
        const dirQ = supabaseClient
          .from("prenotazioni")
          .select("id, checkin, checkout, nome_ospite, stato")
          .eq("struttura_id", struttura_id)
          .lt("checkin", end)
          .gt("checkout", start);

        const abQ = supabaseClient
          .from("eventi_calendario")
          .select("id, titolo, inizio, fine, origine, attivo")
          .eq("struttura_id", struttura_id)
          .eq("origine", "airbnb_ical")
          .eq("attivo", true)
          .lt("inizio", end)
          .gt("fine", start);

        const [dirRes, abRes] = await Promise.all([dirQ, abQ]);

        if (dirRes.error) { console.error("Errore prenotazioni:", dirRes.error); return; }
        if (abRes.error) { console.error("Errore eventi calendario:", abRes.error); return; }

        const events = [
          ...mapAirbnbToEvents(abRes.data),
          ...mapPrenotazioniToEvents(dirRes.data)
        ];

        calendar.removeAllEvents();
        calendar.addEventSource(events);
      } finally {
        setLoading(false);
      }
    }

    function showLoggedUI(logged) {
      el("authCard").style.display = logged ? "none" : "block";
      el("appCard").style.display = logged ? "block" : "none";
      el("btnLogin").disabled = logged;
      el("email").disabled = logged;
      el("password").disabled = logged;
    }

    async function refreshUI() {
      if (!supabaseClient) return;

      const { data } = await supabaseClient.auth.getSession();
      const session = data?.session ?? null;
      const logged = !!session;

      showLoggedUI(logged);

      if (!logged) return;

      const strutture = await loadStrutture();

      requestAnimationFrame(() => requestAnimationFrame(() => ensureCalendar()));

      if (!strutture.length) {
        if (calendar) calendar.removeAllEvents();
        return;
      }

      setTimeout(async () => {
        try { calendar.updateSize(); } catch (_) {}
        const v = calendar.view;
        lastRangeKey = "";
        await reloadCalendarEvents(v.activeStart, v.activeEnd);
      }, 0);
    }

    async function doLogin() {
      if (!supabaseClient) return;

      const { data } = await supabaseClient.auth.getSession();
      if (data?.session) return;

      const email = el("email").value.trim();
      const password = el("password").value;
      if (!email || !password) return;

      try {
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) { console.error("Errore login:", error); return; }
        await refreshUI();
      } catch (e) {
        console.error("Eccezione login:", e);
      }
    }

    async function doLogout() {
      const btn = el("btnLogout");
      if (btn) btn.disabled = true;

      try {
        // 1) Supabase signOut (server + local)
        try { await supabaseClient.auth.signOut(); } catch (_) {}

        // 2) Hard cleanup local storage keys (assicurazione)
        try {
          for (let i = localStorage.length - 1; i >= 0; i--) {
            const k = localStorage.key(i);
            if (!k) continue;
            if (k.startsWith("sb-") || k === STORAGE_KEY) localStorage.removeItem(k);
          }
        } catch (_) {}

        lastRangeKey = "";
        try { if (calendar) calendar.removeAllEvents(); } catch (_) {}

        // 3) Aggiorna UI
        await refreshUI();

        // 4) (Opzionale ma utile) ricarica pagina per azzerare stato JS
        // Commenta la riga seguente se non la vuoi:
        // window.location.reload();
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    // Bind bottoni
    el("btnLogin").addEventListener("click", (e) => { e.preventDefault(); doLogin(); }, { passive: false });
    if (el("btnLogout")) el("btnLogout").addEventListener("click", (e) => { e.preventDefault(); doLogout(); }, { passive: false });

    el("btnReload").addEventListener("click", async (e) => {
      e.preventDefault();
      if (!calendar) return;
      lastRangeKey = "";
      const v = calendar.view;
      await reloadCalendarEvents(v.activeStart, v.activeEnd);
    }, { passive: false });

    el("strutturaSelect").addEventListener("change", async () => {
      if (!calendar) return;
      lastRangeKey = "";
      const v = calendar.view;
      await reloadCalendarEvents(v.activeStart, v.activeEnd);
    });

    // Auth listener
    if (supabaseClient?.auth?.onAuthStateChange) {
      supabaseClient.auth.onAuthStateChange(async () => {
        lastRangeKey = "";
        await refreshUI();
      });
    }

    refreshUI();
  </script>
</body>
</html>
