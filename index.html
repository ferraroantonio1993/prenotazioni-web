<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prenotazioni Dirette</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 860px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 12px 0; }
    label { display:block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 6px; }
    button { padding: 10px 14px; margin-top: 12px; cursor: pointer; }
    pre { background: #f7f7f7; padding: 10px; overflow:auto; }
    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }
  </style>
</head>
<body>
  <h2>Prenotazioni Dirette (test)</h2>

  <div id="authCard" class="card">
    <h3>Login</h3>
    <label>Email <input id="email" type="email" /></label>
    <label>Password <input id="password" type="password" /></label>
    <button id="btnLogin">Accedi</button>
    <button id="btnLogout" style="display:none;">Esci</button>
    <button id="btnReset">Reset sessione</button>
    <div id="authStatus"></div>
  </div>

  <h4>Output</h4>
  <pre id="out"></pre>

  <div id="appCard" class="card" style="display:none;">
    <h3>Nuova prenotazione diretta</h3>

    <label>Struttura
      <select id="strutturaSelect"></select>
    </label>

    <div class="row">
      <div>
        <label>Check-in <input id="checkin" type="date" /></label>
      </div>
      <div>
        <label>Check-out <input id="checkout" type="date" /></label>
      </div>
    </div>

    <label>Nome ospite <input id="nomeOspite" type="text" /></label>

    <div class="row">
      <div>
        <label>Bambini (numero) <input id="bambiniNum" type="number" min="0" value="0" /></label>
      </div>
      <div>
        <label>Stato
          <select id="stato">
            <option value="opzione">opzione</option>
            <option value="confermata" selected>confermata</option>
            <option value="annullata">annullata</option>
            <option value="checkin">checkin</option>
            <option value="checkout">checkout</option>
          </select>
        </label>
      </div>
    </div>

    <label><input id="lateCheckin" type="checkbox" /> Late check-in</label>
    <label><input id="animali" type="checkbox" /> Animali</label>
    <label><input id="pulizieRich" type="checkbox" checked /> Pulizie richieste</label>

    <label>Note operative
      <textarea id="note" rows="3"></textarea>
    </label>

    <button id="btnCheck">Verifica conflitti</button>
    <button id="btnSave">Salva prenotazione</button>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://ybzoitxmlkjmfeoodqlq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inliem9pdHhtbGtqbWZlb29kcWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MTI2MTIsImV4cCI6MjA4NDM4ODYxMn0.3kV-SnYCjvNay2PjZpz-MA6PZFDS-ZeAgufFbk1ZR6M";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    const el = (id) => document.getElementById(id);

    // Logger robusto: solo stringhe sullo schermo, console sempre
    const log = (msg) => {
      const s = String(msg);
      console.log("[APP]", s);
      const target = document.getElementById("out");
      if (target) target.textContent = s;
    };

    log("Script caricato. Inserisci email e password e premi Accedi.");

    const clearSbStorage = () => {
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const k = localStorage.key(i);
        if (k && k.startsWith("sb-")) localStorage.removeItem(k);
      }
      sessionStorage.clear();
    };

    const hardReload = () => {
      // evita cache: URL cambia sempre
      const base = window.location.origin + window.location.pathname;
      window.location.href = base + "?v=" + Date.now();
    };

    async function loadStrutture() {
      const { data, error } = await supabase
        .from("strutture")
        .select("id,nome")
        .order("nome");

      if (error) {
        log("Errore caricamento strutture: " + (error.message ?? String(error)));
        return;
      }

      const sel = el("strutturaSelect");
      sel.innerHTML = "";
      for (const s of (data ?? [])) {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = `${s.nome} (${s.id.slice(0,8)}â€¦)`;
        sel.appendChild(opt);
      }
    }

    async function refreshUI() {
      const { data, error } = await supabase.auth.getSession();
      const session = data?.session ?? null;

      if (error) log("Errore getSession: " + (error.message ?? String(error)));

      const logged = !!session;

      el("btnLogin").style.display = logged ? "none" : "inline-block";
      el("btnLogout").style.display = logged ? "inline-block" : "none";
      el("appCard").style.display = logged ? "block" : "none";
      el("authStatus").textContent = logged
        ? `Loggato come: ${session.user.email}`
        : "Non loggato";

      if (!logged) {
        const sel = el("strutturaSelect");
        if (sel) sel.innerHTML = "";
        return;
      }

      await loadStrutture();
    }

    el("btnLogin").onclick = async () => {
      try {
        const email = el("email").value.trim();
        const password = el("password").value;

        if (!email || !password) {
          log("Inserisci email e password.");
          return;
        }

        log("Tentativo login...");
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
          log("Errore login: " + (error.message ?? String(error)));
          await refreshUI();
          return;
        }

        await refreshUI();
        log("Login OK: " + (data.user?.email ?? ""));
      } catch (e) {
        log("Errore login (catch): " + String(e));
      }
    };

    // ESCl = Reset pulito (evita di perdere tempo su signOut incerto)
    el("btnLogout").onclick = async () => {
      try { await supabase.auth.signOut(); } catch (_) {}
      clearSbStorage();

      // UI immediata
      el("appCard").style.display = "none";
      el("btnLogout").style.display = "none";
      el("btnLogin").style.display = "inline-block";
      el("authStatus").textContent = "Non loggato";

      log("Uscito. Ricarico...");
      hardReload();
    };

    el("btnReset").onclick = async () => {
      try { await supabase.auth.signOut(); } catch (_) {}
      clearSbStorage();
      log("Reset completato. Ricarico...");
      hardReload();
    };

    supabase.auth.onAuthStateChange(async () => {
      await refreshUI();
    });

    el("btnCheck").onclick = async () => {
      try {
        const struttura_id = el("strutturaSelect").value;
        const checkin = el("checkin").value;
        const checkout = el("checkout").value;

        if (!struttura_id || !checkin || !checkout) {
          log("Seleziona struttura e inserisci check-in/check-out.");
          return;
        }

        log(`Controllo conflitti: struttura=${struttura_id} checkin=${checkin} checkout=${checkout}`);

        const { data, error } = await supabase.rpc("fn_conflitti_calendario", {
          p_struttura_id: struttura_id,
          p_checkin: checkin,
          p_checkout: checkout,
          p_escludi_prenotazione_id: null
        });

        if (error) {
          log("Errore conflitti: " + (error.message ?? String(error)));
          return;
        }

        const conf = data?.[0];
        if (!conf) {
          log("Risposta conflitti vuota.");
          return;
        }

        if (conf.conflitto) {
          log("CONFLITTO: " + (conf.conflitti?.[0]?.titolo ?? "occupato"));
        } else {
          log("Nessun conflitto.");
        }
      } catch (e) {
        log("Errore verifica conflitti (catch): " + String(e));
      }
    };

    el("btnSave").onclick = async () => {
      try {
        const struttura_id = el("strutturaSelect").value;
        const checkin = el("checkin").value;
        const checkout = el("checkout").value;

        if (!struttura_id || !checkin || !checkout) {
          log("Seleziona struttura e inserisci check-in/check-out.");
          return;
        }

        // 1) verifica conflitti
        const { data: confData, error: confErr } = await supabase.rpc("fn_conflitti_calendario", {
          p_struttura_id: struttura_id,
          p_checkin: checkin,
          p_checkout: checkout,
          p_escludi_prenotazione_id: null
        });

        if (confErr) {
          log("Errore conflitti (salva): " + (confErr.message ?? String(confErr)));
          return;
        }

        const conf = confData?.[0];
        if (conf?.conflitto) {
          log("Salvataggio bloccato: conflitto presente.");
          return;
        }

        // 2) inserisci prenotazione (il trigger DB blocca comunque in caso di conflitto)
        const userRes = await supabase.auth.getUser();
        const user = userRes?.data?.user ?? null;

        const payload = {
          struttura_id,
          checkin,
          checkout,
          nome_ospite: el("nomeOspite").value.trim(),
          stato: el("stato").value,
          note_operativo: el("note").value,
          late_checkin: el("lateCheckin").checked,
          animali: el("animali").checked,
          bambini_num: parseInt(el("bambiniNum").value || "0", 10),
          pulizie_richieste: el("pulizieRich").checked,
          creato_da: user?.id ?? null
        };

        const { data, error } = await supabase
          .from("prenotazioni")
          .insert(payload)
          .select()
          .single();

        if (error) {
          log("Errore inserimento prenotazione: " + (error.message ?? String(error)));
          return;
        }

        log("Prenotazione salvata. ID: " + (data?.id ?? ""));
      } catch (e) {
        log("Errore salva prenotazione (catch): " + String(e));
      }
    };

    await refreshUI();
  </script>
</body>
</html>
